---
/**
 * CenTI-R - Panel de administración
 */
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de administración - CenTI-R</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <header class="app-header">
      <a href="/admin/panel/" class="logo-link">CenTI-R Admin</a>
      <nav class="nav">
        <a href="/admin/panel/" class="nav-link active">Citas</a>
        <a href="/admin/panel/terapeutas/" class="nav-link">Terapeutas</a>
        <span class="user-name" id="userName">Admin</span>
        <a href="#" class="btn-logout" id="btnLogout">Cerrar sesión</a>
      </nav>
    </header>

    <main class="main">
      <h1>Todas las citas</h1>
      <p class="panel-desc">Vista de todas las citas del centro. Puedes enviar recordatorios y confirmaciones por WhatsApp a los pacientes.</p>
      <div id="citasList" class="citas-list">
        <p class="loading">Cargando...</p>
      </div>
    </main>
  </div>

  <script>
    const API = (typeof window !== 'undefined' && window.location.hostname === 'localhost' && ['4321','4322','4323'].includes(window.location.port || '')) ? 'http://localhost:8080/api' : '/api';
    const fetchOpts = (opts = {}) => ({ ...opts, credentials: 'include' });

    async function checkAuth() {
      const res = await fetch(`${API}/auth`, fetchOpts());
      const data = await res.json();
      if (!data.logged || data.user.rol !== 'admin') {
        window.location.href = '/admin/';
        return null;
      }
      return data.user;
    }

    async function logout() {
      await fetch(`${API}/auth`, fetchOpts({ method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'logout' }) }));
      window.location.href = '/admin/';
    }

    async function loadCitas() {
      const res = await fetch(`${API}/citas`, fetchOpts());
      if (res.status === 401) { window.location.href = '/admin/'; return; }
      return res.json();
    }

    const estados = { pendiente: 'Pendiente', confirmada: 'Confirmada', completada: 'Completada', cancelada: 'Cancelada', no_asistio: 'No asistió' };

    async function enviarRecordatorio(citaId) {
      try {
        const res = await fetch(`${API}/recordatorios`, fetchOpts({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cita_id: citaId, accion: 'recordatorio' })
        }));
        const json = await res.json();
        alert(json.success ? json.message : (json.error || 'Error'));
      } catch (e) { alert('Error de conexión'); }
    }

    async function confirmarCitaWhatsApp(citaId) {
      try {
        const res = await fetch(`${API}/recordatorios`, fetchOpts({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cita_id: citaId, accion: 'confirmar' })
        }));
        const json = await res.json();
        alert(json.success ? json.message : (json.error || 'Error'));
        if (json.success) loadCitas().then(renderCitas);
      } catch (e) { alert('Error de conexión'); }
    }

    function renderCitas(citas) {
      const list = document.getElementById('citasList');
      if (!citas || citas.length === 0) {
        list.innerHTML = '<p class="empty">No hay citas registradas.</p>';
        return;
      }
      list.innerHTML = citas.map(c => `
        <div class="cita-card" data-id="${c.id}">
          <div class="cita-header">
            <span class="cita-fecha">${c.fecha} ${c.hora_inicio}</span>
            <span class="cita-estado">${estados[c.estado] || c.estado}</span>
          </div>
          <div class="cita-body">
            <p><strong>Paciente:</strong> ${c.paciente_nombre}</p>
            <p><strong>Terapeuta:</strong> ${c.terapeuta_nombre} ${c.especialidad ? '(' + c.especialidad + ')' : ''}</p>
            <p><strong>Modalidad:</strong> ${c.modalidad === 'en_linea' ? 'En línea' : 'Presencial'}</p>
          </div>
          ${(c.estado === 'pendiente' || c.estado === 'confirmada') ? `
          <div class="cita-actions">
            <button class="btn-whatsapp" data-id="${c.id}" data-action="recordatorio">Enviar recordatorio WhatsApp</button>
            <button class="btn-whatsapp btn-confirmar" data-id="${c.id}" data-action="confirmar">Confirmar cita por WhatsApp</button>
          </div>
          ` : ''}
        </div>
      `).join('');

      list.querySelectorAll('.btn-whatsapp').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          btn.dataset.action === 'confirmar' ? confirmarCitaWhatsApp(id) : enviarRecordatorio(id);
        });
      });
    }

    (async () => {
      const user = await checkAuth();
      if (!user) return;
      document.getElementById('userName').textContent = user.nombre;
      document.getElementById('btnLogout').addEventListener('click', (e) => { e.preventDefault(); logout(); });
      const citas = await loadCitas();
      renderCitas(citas);
    })();
  </script>
</body>
</html>

<style is:global>
  :root { --centir-pink: #E91E8C; --centir-purple: #9C27B0; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { min-height: 100vh; font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: #f5f5f7; }
  .app { min-height: 100vh; }
  .app-header { background: linear-gradient(135deg, #1a1a2e, #16213e); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
  .logo-link { color: white; text-decoration: none; font-weight: 800; }
  .nav { display: flex; align-items: center; gap: 1.5rem; }
  .nav-link { color: rgba(255,255,255,0.8); text-decoration: none; }
  .nav-link.active { color: white; font-weight: 600; }
  .user-name { font-weight: 600; }
  .btn-logout { color: rgba(255,255,255,0.8); text-decoration: none; }
  .main { padding: 2rem; max-width: 1000px; margin: 0 auto; }
  .main h1 { margin-bottom: 0.5rem; }
  .panel-desc { color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; }
  .citas-list { display: flex; flex-direction: column; gap: 1rem; }
  .cita-card { background: white; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .cita-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
  .cita-fecha { font-weight: 700; }
  .cita-estado { font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 999px; background: rgba(0,0,0,0.04); }
  .cita-body p { margin-bottom: 0.35rem; }
  .cita-actions { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn-whatsapp { padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #25D366; color: #fff; border: none; border-radius: 0.35rem; cursor: pointer; }
  .btn-whatsapp:hover { opacity: 0.9; }
  .btn-confirmar { background: #128C7E; }
  .loading, .empty { color: #666; padding: 2rem; }
</style>
