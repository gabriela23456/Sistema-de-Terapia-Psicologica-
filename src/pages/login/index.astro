---
/**
 * CenTI-R - Inicio de sesión / Registro
 */
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar sesión | CenTI-R</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="login-page">
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;" id="toastContainer"></div>
  <div class="login-wrap">
    <header class="login-header">
      <a href="/" class="back-home">← Volver al inicio</a>
      <a href="/" class="logo">CenTI-R</a>
    </header>

    <main class="login-main">
      <div class="login-card">
        <h1>Acceso a tu cuenta</h1>
        <p class="login-sub">Inicia sesión para agendar citas, ver tu historial y realizar pagos.</p>

        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label for="nombre">Nombre</label>
            <input type="text" id="nombre" name="nombre" placeholder="Nombre(s)" />
          </div>
          <div class="form-group">
            <label for="email">Correo electrónico</label>
            <input type="email" id="email" name="email" placeholder="tu@correo.com" required />
          </div>
          <div class="form-group">
            <label for="password">Contraseña</label>
            <input type="password" id="password" name="password" placeholder="••••••••" required />
          </div>
          <div class="form-group form-group--confirm">
            <label for="confirmar_password">Confirmar contraseña</label>
            <input type="password" id="confirmar_password" name="confirmar_password" placeholder="••••••••" />
          </div>
          <div id="alertContainer" aria-live="polite"></div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" name="action" value="login">Iniciar sesión</button>
            <button type="button" class="btn btn-secondary" id="btnRegistrar">Crear cuenta</button>
          </div>
        </form>

        <p class="login-footer-link"><a href="/admin/">Soy administrador</a></p>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById('loginForm');
    const alertContainer = document.getElementById('alertContainer');
    const confirmGroup = document.querySelector('.form-group--confirm');
    const nombreGroup = document.querySelector('#nombre')?.closest('.form-group');
    let isRegisterMode = false;
    function showToast(type, title, body) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const id = 'toast-' + Date.now();
      const bg = type === 'success' ? 'success' : 'danger';
      container.insertAdjacentHTML('beforeend', `
        <div class="toast align-items-center text-bg-${bg} border-0" id="${id}" role="alert">
          <div class="d-flex">
            <div class="toast-body"><strong>${title}</strong>${body ? '<br>' + body : ''}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `);
      const el = document.getElementById(id);
      const toast = new bootstrap.Toast(el, { delay: 5000 });
      toast.show();
      el.addEventListener('hidden.bs.toast', () => el.remove());
    }
    function showAlert(type, msg) {
      const pref = type === 'danger' ? '<strong>Error:</strong> ' : '';
      alertContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${pref}${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }
    function toggleMode() {
      isRegisterMode = !isRegisterMode;
      confirmGroup.style.display = isRegisterMode ? 'block' : 'none';
      nombreGroup.style.display = isRegisterMode ? 'block' : 'none';
      document.querySelector('.btn-primary').textContent = isRegisterMode ? 'Crear cuenta' : 'Iniciar sesión';
      document.getElementById('btnRegistrar').textContent = isRegisterMode ? 'Ya tengo cuenta' : 'Crear cuenta';
      alertContainer.innerHTML = '';
    }
    document.getElementById('btnRegistrar').addEventListener('click', toggleMode);
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      alertContainer.innerHTML = '';
      const data = Object.fromEntries(new FormData(form));
      if (isRegisterMode) {
        data.action = 'register';
        if (!data.nombre?.trim()) { showAlert('danger', 'El nombre es requerido'); return; }
        if (data.password !== data.confirmar_password) { showAlert('danger', 'Las contraseñas no coinciden'); return; }
      } else {
        data.action = 'login';
        delete data.nombre;
        delete data.confirmar_password;
      }
      try {
        const API = (typeof window !== 'undefined' && window.location.hostname === 'localhost' && ['4321','4322','4323'].includes(window.location.port || '')) ? 'http://localhost:8080/api' : '/api';
        const res = await fetch(`${API}/auth`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data), credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          const urlParams = new URLSearchParams(location.search);
          window.location.href = urlParams.get('redirect') || '/dashboard/';
        } else {
          const errMsg = json.errors ? json.errors.join(', ') : (json.error || 'Error al procesar');
          showAlert('danger', errMsg);
          showToast('danger', 'Error', errMsg);
        }
      } catch {
        showAlert('danger', 'Error de conexión.');
        showToast('danger', 'Error', 'Error de conexión. Verifica el servidor.');
      }
    });
  </script>

  <style is:global>
    :root { --primary: #5B4B8A; --primary-dark: #4A3D72; --text: #1C1917; --text-muted: #57534E; --border: #E7E5E4; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body.login-page { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; min-height: 100vh; background: #FAFAF9; color: var(--text); display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
    .login-wrap { width: 100%; max-width: 440px; }
    .login-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .back-home { color: var(--text-muted); font-size: 0.9rem; text-decoration: none; }
    .back-home:hover { color: var(--primary); }
    .logo { font-size: 1.25rem; font-weight: 800; color: var(--primary); text-decoration: none; }
    .login-card { background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 24px rgba(0,0,0,0.06); border: 1px solid var(--border); }
    .login-card h1 { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; }
    .login-sub { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 1.5rem; }
    .auth-form .form-group--confirm, .auth-form .form-group:has(#nombre) { display: none; }
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.35rem; color: var(--text); }
    .form-group input { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; font-family: inherit; }
    .form-group input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,75,138,0.15); }
    #alertContainer { margin-bottom: 1rem; }
    .form-actions { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; }
    .btn { padding: 0.875rem 1.5rem; font-weight: 600; font-size: 1rem; border-radius: 10px; border: none; cursor: pointer; font-family: inherit; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
    .btn-secondary:hover { background: rgba(91,75,138,0.08); }
    .login-footer-link { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; }
    .login-footer-link a { color: var(--text-muted); text-decoration: none; }
    .login-footer-link a:hover { color: var(--primary); }
  </style>
</body>
</html>
